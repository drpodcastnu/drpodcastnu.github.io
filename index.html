<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DR Podcasts</title>
    <meta
        name="description"
        content="Genudgivelse af podcasts fra DR som RSS, uden forsinkelser."
    />

    <!-- Custom.css -->
    <link rel="stylesheet" href="css/custom.css" />
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.css" />
</head>

<body>
<a href="https://github.com/drpodcastnu">
    <img style="position: absolute; right: 0; width:40px; height:40px; margin: 15px;" src="github-mark.png" alt="GitHub" />
</a>
<!-- Header -->
<header class="container">
    <hgroup>
        <h1>DR Podcasts</h1>
        <h2>Genudgivelse af podcasts fra DR som RSS, uden forsinkelser.</h2>
    </hgroup>
</header>
<!-- ./ Header -->
<!-- Main -->
<main class="container">
    <section id="podcasts">
        <h2>Podcasts</h2>
        <table id="podcast-table" class="display compact" style="width: 100%;">
        </table>
    </section>
    <section>
        <h2>Hvad er dette?</h2>
        <p>DR har for nyligt valgt at et udvalg af deres podcasts ikke længere skal være tilgængelige som RSS-feeds, eller at de RSS-feeds de publicerer er forsinkede med flere dage. Dette betyder at du som lytter ikke kan bruge den app du foretrækker, men at du bliver tvunget til at bruge DR's app "DR Lyd".</p>
        <p>Argumentet som DR bruger er, at de ikke vil lade store techgiganter som Spotify bestemme over DR's indhold. Dette argument giver ikke nogen mening, da DR samtidig også afskærer alle andre 3. parts apps fra at abonnere på deres podcasts.</p>
        <p>Dette går direkte imod DR's public service forpligtelser, og svarer til at bestemme at du kun må bruge en radio produceret af DR til at lytte til DR's programmer. I værste fald er DR med til yderligere at normalisere tendensen til, at indhold gemmes bag betalingsmure og proprietære apps i stedet for at blive gjort tilgængeligt via de åbne web-standarder der allerede findes, og som sikrer at folk kan bruge den software de foretrækker.</p>
        <p>De RSS-feeds du kan finde på denne side kan du importere i de fleste RSS-læsere som understøtter import af vilkårlige RSS URL'er. Med tiden kan det også være at du vil kunne finde dem direkte i den app du foretrækker, såfremt deres indekseringsrobot har fundet dem.</p>
    </section>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.3.4/js/dataTables.js"></script>
<script>
    function escapeHtml(text) {
        return $('<div>').text(text ?? '').html();
    }

    function fallbackCopyText(text) {
        const temp = $('<textarea>').val(text).css({
            position: 'fixed',
            top: '-1000px',
            left: '-1000px',
            opacity: 0
        }).appendTo('body');

        let success = false;
        try {
            temp[0].select();
            success = document.execCommand('copy');
        } catch (error) {
            console.error('Fallback-kopi fejlede', error);
            success = false;
        } finally {
            temp.remove();
        }

        return success;
    }

    function markButtonCopied($button) {
        const originalText = $button.data('label') || $button.text();
        $button.data('label', originalText);

        if ($button.data('resetTimeout')) {
            clearTimeout($button.data('resetTimeout'));
        }

        $button.addClass('copied');

        const timeoutId = setTimeout(function () {
            $button.text($button.data('label'));
            $button.removeClass('copied');
            $button.data('resetTimeout', null);
        }, 2000);

        $button.data('resetTimeout', timeoutId);
    }

    $(function () {
        const table = $('#podcast-table').DataTable({
            ajax: {
                url: 'data.json',
                dataSrc: ''
            },
            columns: [
                {
                    data: null,
                    title: '',
                    orderable: false,
                    searchable: false,
                    className: 'dt-body-center copy-column',
                    width: '1%',
                    render: function (data, type, row) {
                        const slug = row.slug || '';
                        const feedPath = encodeURI(slug + '/feed.xml');
                        if (type === 'display') {
                            const safeFeed = escapeHtml(feedPath);
                            return '<button type="button" class="copy-rss" data-feed="' + safeFeed + '">Kopiér</button>';
                        }
                        return feedPath;
                    }
                },
                {
                    data: 'title',
                    title: 'Titel',
                    render: function (data, type, row) {
                        const slug = row.slug || '';
                        const feedUrl = encodeURI(slug + '/feed.xml');
                        const safeTitle = escapeHtml(data);
                        if (type === 'display') {
                            return '<a href="' + feedUrl + '">' + safeTitle + '</a>';
                        }
                        return data;
                    }
                },
                {
                    data: 'episodeCount',
                    title: 'Afsnit',
                    className: 'dt-body-right'
                },
                {
                    data: 'lastUpdated',
                    title: 'Opdateret',
                    render: {
                        _: 'display',
                        order: 'sort'
                    }
                },
                {
                    data: 'presentationUrl',
                    title: '',
                    orderable: false,
                    searchable: false,
                    render: function (data, type) {
                        if (!data) {
                            return type === 'display' ? '' : data;
                        }
                        const safeUrl = encodeURI(data);
                        if (type === 'display') {
                            return '<a href="' + safeUrl + '" target="_blank" rel="noopener noreferrer">Åbn på DR</a>';
                        }
                        return data;
                    }
                }
            ],
            order: [[3, 'desc']],
            stateSave: true,
            language: {
                decimal: ',',
                thousands: '.',
                processing: 'Henter...',
                search: 'Søg:',
                lengthMenu: 'Vis _MENU_ podcasts',
                info: 'Viser _START_ til _END_ af _TOTAL_ podcasts',
                infoEmpty: 'Viser 0 til 0 af 0 podcasts',
                infoFiltered: '(filtreret fra _MAX_ podcasts)',
                infoPostFix: '',
                loadingRecords: 'Indlæser...',
                zeroRecords: 'Ingen podcasts fundet',
                emptyTable: 'Ingen data tilgængelig i tabellen',
                paginate: {
                    first: 'Første',
                    previous: 'Forrige',
                    next: 'Næste',
                    last: 'Sidste'
                },
                aria: {
                    sortAscending: ': aktiver for at sortere kolonnen stigende',
                    sortDescending: ': aktiver for at sortere kolonnen faldende'
                }
            }
        });

        $('#podcast-table').on('click', '.copy-rss', function (event) {
            event.preventDefault();

            const $button = $(this);
            const feedPath = $button.data('feed');
            if (!feedPath) {
                return;
            }

            const absoluteUrl = new URL(feedPath, window.location.href).href;

            const onSuccess = function () {
                markButtonCopied($button);
            };

            const onFailure = function (error) {
                console.error('Kunne ikke kopiere RSS-linket', error);
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(absoluteUrl).then(onSuccess).catch(function () {
                    if (fallbackCopyText(absoluteUrl)) {
                        onSuccess();
                    } else {
                        onFailure();
                    }
                });
            } else if (fallbackCopyText(absoluteUrl)) {
                onSuccess();
            } else {
                onFailure();
            }
        });
    });
</script>
</body>
</html>
